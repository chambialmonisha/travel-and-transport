<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AR Food Menu</title>

<!-- âœ… COMPATIBLE LIBRARIES -->
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ---- KEEP YOUR EXISTING CSS (UNCHANGED) ---- */
body{margin:0;overflow:hidden;font-family:'Inter',sans-serif;background:#0b0b0c;color:white;}
a-scene{pointer-events:none;}
#topBar,#infoCard,#toast,#controls,#quickActions,#ratingMenu,#cartModal,#filterMenu,.fab,.fab-menu{pointer-events:auto;}
#loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0b0b0c;z-index:200}
#loadingBar{width:200px;height:4px;background:#333;border-radius:2px;overflow:hidden}
#loadingProgress{height:100%;background:linear-gradient(90deg,#1f7aff,#0066ff);width:0%}
</style>
</head>

<body>

<div id="loading">
  <div id="loadingText">Loading modelsâ€¦</div>
  <div id="loadingBar"><div id="loadingProgress"></div></div>
</div>

<div id="toast"></div>

<!-- âœ… MARKERLESS AR SCENE -->
<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="colorManagement:true"
  arjs="sourceType:webcam; videoTexture:true; debugUIEnabled:false;"
>

  <a-entity light="type:ambient; intensity:0.9"></a-entity>
  <a-entity light="type:directional; intensity:0.6" position="1 2 1"></a-entity>

  <!-- âœ… CORRECT CAMERA FOR MARKERLESS -->
  <a-camera position="0 1.6 0"></a-camera>

  <!-- Model holder -->
  <a-entity id="holder" position="0 0 -4"></a-entity>

</a-scene>

<script>
/* ---------------- DATA ---------------- */
const foods=[

 {model:"models/bus/scene.gltf",name:"Bus",price:299,scale:2},
 
];

const holder=document.getElementById("holder");
const loading=document.getElementById("loading");
const loadingText=document.getElementById("loadingText");
const loadingProgress=document.getElementById("loadingProgress");
const toast=document.getElementById("toast");

const models=[];
let index=0;

/* ---------------- TOAST ---------------- */
function showToast(msg){
 toast.textContent=msg;
 toast.style.opacity=1;
 setTimeout(()=>toast.style.opacity=0,1800);
}

/* ---------------- SHOW MODEL ---------------- */
function showFood(i){
 models.forEach((m,idx)=>{
  if(m) m.object3D.visible = idx===i;
 });
 index=i;
}

/* ---------------- SEQUENTIAL PRELOAD (SAFE) ---------------- */
const perModelTimeout = 10000;
let loadedCount = 0;

// ensure array size
for(let i=0;i<foods.length;i++) models[i]=null;

function updateLoading(){
 const p=(loadedCount/foods.length)*100;
 loadingProgress.style.width=p+"%";
 loadingText.textContent=`Loading modelsâ€¦ ${loadedCount}/${foods.length}`;
}

function loadModelAt(i){
 if(i>=foods.length){
  loading.style.display="none";
  showFood(0);
  showToast("Welcome to FoodAR ðŸ‘‹");
  return;
 }

 const food=foods[i];
 const m=document.createElement("a-entity");
 m.setAttribute("gltf-model",food.model);
 m.object3D.visible=false;
 holder.appendChild(m);
 models[i]=m;

 let finished=false;

 const timer=setTimeout(()=>{
  if(!finished){
   console.warn("Timeout:",food.model);
   cleanup();
  }
 },perModelTimeout);

 function cleanup(){
  finished=true;
  clearTimeout(timer);
  loadedCount++;
  updateLoading();
  try{m.parentNode.removeChild(m);}catch(e){}
  loadModelAt(i+1);
 }

 m.addEventListener("model-loaded",()=>{
  if(finished) return;
  finished=true;
  clearTimeout(timer);
  m.object3D.scale.set(food.scale,food.scale,food.scale);
  loadedCount++;
  updateLoading();
  loadModelAt(i+1);
 });

 m.addEventListener("model-error",(e)=>{
  console.error("Model error:",food.model,e);
  cleanup();
 });
}

// Global fallback
setTimeout(()=>{
 if(loadedCount<foods.length){
  console.warn("Global timeout");
  loading.style.display="none";
  showFood(0);
 }
},30000);

// Start loading
loadModelAt(0);

/* ---------------- AUTO ROTATE ---------------- */
let yaw=0;
AFRAME.registerComponent("spin",{
 tick:function(){
  if(models[index]){
   yaw+=0.002;
   models[index].object3D.rotation.y=yaw;
  }
 }
});
holder.setAttribute("spin","");

</script>

</body>
</html>
